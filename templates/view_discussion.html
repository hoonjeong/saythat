<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ discussion.subject }} - SayThat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/view_discussion.css') }}">
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <h1 onclick="location.href='/'">SayThat</h1>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="í† ë¡  ì£¼ì œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”">
                <button class="search-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
            <div class="auth-buttons">
                {% if session.user_id %}
                    <span class="user-name">
                        {% if user_level %}
                        <span class="level-wrapper">
                            <span class="level-icon">{{ user_level.level_icon }}</span>
                            <div class="level-tooltip">
                                ì°¬ì„±, ë°˜ëŒ€ íˆ¬í‘œì‹œ ë ˆë²¨ì— ë”°ë¼ ì¶”ì²œìˆ˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.<br><br>
                                ğŸ’€ í•´ê³¨ : +1 íš¨ê³¼<br>
                                ğŸ¥‰ ë™ë©”ë‹¬ : +2 íš¨ê³¼<br>
                                ğŸ¥ˆ ì€ë©”ë‹¬ : +4 íš¨ê³¼<br>
                                ğŸ¥‡ ê¸ˆë©”ë‹¬ : +8 íš¨ê³¼<br>
                                ğŸ’ ë‹¤ì´ì•„ : +16 íš¨ê³¼<br><br>
                                <strong>í˜„ì¬: {{ user_level.level_name }} (+{{ user_level.voting_power }})</strong><br><br>
                                <span style="color: #ff6b6b; font-size: 11px;">âš ï¸ ë¶€ì •í•œ ë°©ë²•ìœ¼ë¡œ í¬ì¸íŠ¸ë¥¼ ì–´ë·°ì§•í•˜ëŠ” ê²½ìš°,<br>í•´ê³¨ë¡œ ê°•ë“±ë  ìˆ˜ ìˆìŒ</span>
                            </div>
                        </span>
                        {% endif %}
                        {{ session.user_nick }}
                        {% if user_level %}
                        <span class="user-points">({{ user_level.point }}P)</span>
                        {% endif %}
                    </span>
                    <button class="btn-logout" onclick="location.href='/logout'">ë¡œê·¸ì•„ì›ƒ</button>
                {% else %}
                    <button class="btn-login" onclick="location.href='/login'">ë¡œê·¸ì¸</button>
                    <button class="btn-signup" onclick="location.href='/register'">íšŒì›ê°€ì…</button>
                {% endif %}
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="discussion-container">
                <!-- í† ë¡  ì œëª© -->
                <h1 class="discussion-title">{{ discussion.subject }}</h1>
                
                <!-- í† ë¡  ë©”íƒ€ ì •ë³´ -->
                <div class="discussion-meta">
                    <span class="meta-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        {{ discussion.insert_time.strftime('%Y-%m-%d %H:%M') }}
                    </span>
                    <span class="meta-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        {% if discussion.author %}
                            {% if discussion.author.level_info %}
                            <span class="level-wrapper">
                                <span class="level-icon-small">{{ discussion.author.level_info.level_icon }}</span>
                                <div class="level-tooltip">
                                    ì°¬ì„±, ë°˜ëŒ€ íˆ¬í‘œì‹œ ë ˆë²¨ì— ë”°ë¼ ì¶”ì²œìˆ˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.<br><br>
                                    ğŸ’€ í•´ê³¨ : +1 íš¨ê³¼<br>
                                    ğŸ¥‰ ë™ë©”ë‹¬ : +2 íš¨ê³¼<br>
                                    ğŸ¥ˆ ì€ë©”ë‹¬ : +4 íš¨ê³¼<br>
                                    ğŸ¥‡ ê¸ˆë©”ë‹¬ : +8 íš¨ê³¼<br>
                                    ğŸ’ ë‹¤ì´ì•„ : +16 íš¨ê³¼<br><br>
                                    <strong>í˜„ì¬: {{ discussion.author.level_info.level_name }} (+{{ discussion.author.level_info.voting_power }})</strong><br><br>
                                    <span style="color: #ff6b6b; font-size: 11px;">âš ï¸ ë¶€ì •í•œ ë°©ë²•ìœ¼ë¡œ í¬ì¸íŠ¸ë¥¼ ì–´ë·°ì§•í•˜ëŠ” ê²½ìš°,<br>í•´ê³¨ë¡œ ê°•ë“±ë  ìˆ˜ ìˆìŒ</span>
                                </div>
                            </span>
                            {% endif %}
                            {{ discussion.author.nick }}
                            {% if discussion.author.level_info %}
                            <span class="user-points-small">({{ discussion.author.level_info.point }}P)</span>
                            {% endif %}
                        {% else %}
                            Unknown
                        {% endif %}
                    </span>
                    <span class="meta-item vote-info">
                        <span class="chan">ì°¬ì„± {{ discussion.chan }}</span>
                        <span class="ban">ë°˜ëŒ€ {{ discussion.ban }}</span>
                    </span>
                    <span class="meta-item">
                        ğŸ’¬ {{ discussion.comments|length }} ëŒ“ê¸€
                    </span>
                    <span class="meta-item">
                        ğŸ‘ {{ discussion.view_count }} ì¡°íšŒ
                    </span>
                    {% if is_author %}
                    <span class="meta-item">
                        <a href="/edit-discussion/{{ discussion.id }}" class="edit-link">ìˆ˜ì •</a>
                        <a href="#" onclick="deleteDiscussion()" class="delete-link">ì‚­ì œ</a>
                    </span>
                    {% endif %}
                </div>

                <!-- í† ë¡  ë‚´ìš© -->
                <div class="discussion-content">
                    {{ discussion.content|safe }}
                </div>

                <!-- íˆ¬í‘œ ë²„íŠ¼ -->
                <div class="vote-buttons">
                    <button class="vote-btn chan-btn" onclick="vote('chan')" {% if voted or is_author %}disabled{% endif %}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                        </svg>
                        ì°¬ì„± ({{ discussion.chan }})
                    </button>
                    <button class="vote-btn ban-btn" onclick="vote('ban')" {% if voted or is_author %}disabled{% endif %}>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                        </svg>
                        ë°˜ëŒ€ ({{ discussion.ban }})
                    </button>
                    <button class="vote-btn list-btn" onclick="location.href='/'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                        ëª©ë¡ìœ¼ë¡œ
                    </button>
                </div>

                {% if is_author %}
                <div class="vote-message">ìì‹ ì´ ì‘ì„±í•œ ê¸€ì—ëŠ” íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                {% elif voted %}
                <div class="vote-message">ì´ë¯¸ {{ voted }}ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤.</div>
                {% endif %}

                <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
                <div class="comment-form">
                    <h3>ëŒ“ê¸€ ì‘ì„±</h3>
                    <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." rows="4"></textarea>
                    <div class="comment-options">
                        <div class="opinion-select">
                            <label>
                                <input type="radio" name="opinion" value="1" checked>
                                <span class="opinion-label chan">ì°¬ì„±</span>
                            </label>
                            <label>
                                <input type="radio" name="opinion" value="0">
                                <span class="opinion-label ban">ë°˜ëŒ€</span>
                            </label>
                        </div>
                        <button class="btn-save-comment" onclick="saveComment()">ëŒ“ê¸€ ì €ì¥</button>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div class="comments-section">
                    <div class="comments-header">
                        <h3>ëŒ“ê¸€ ({{ comments|length }})</h3>
                        <div class="sort-options">
                            <a href="/discussion/{{ discussion.id }}?sort=best" 
                               class="sort-btn {% if sort_order == 'best' %}active{% endif %}">ì¶”ì²œìˆœ</a>
                            <a href="/discussion/{{ discussion.id }}?sort=newest" 
                               class="sort-btn {% if sort_order == 'newest' %}active{% endif %}">ìµœì‹ ìˆœ</a>
                        </div>
                    </div>
                    {% if comments %}
                        <div class="comments-list">
                            {% for comment in comments %}
                            <div class="comment-item {% if loop.index <= best_count and sort_order == 'best' %}best-comment{% endif %}">
                                {% if loop.index <= best_count and sort_order == 'best' %}
                                <span class="best-badge">BEST {{ loop.index }}</span>
                                {% endif %}
                                <div class="comment-header">
                                    <span class="comment-opinion {{ 'chan' if comment.chanban == 1 else 'ban' }}">
                                        {{ 'ì°¬ì„±' if comment.chanban == 1 else 'ë°˜ëŒ€' }}
                                    </span>
                                    <span class="comment-content">{{ comment.content }}</span>
                                </div>
                                <div class="comment-footer">
                                    <span class="comment-meta">
                                        {{ comment.insert_time.strftime('%Y-%m-%d %H:%M') }} | 
                                        ì‘ì„±ì: 
                                        {% if comment.author %}
                                            {% if comment.author.level_info %}
                                            <span class="level-wrapper">
                                                <span class="level-icon-small">{{ comment.author.level_info.level_icon }}</span>
                                                <div class="level-tooltip">
                                                    ì°¬ì„±, ë°˜ëŒ€ íˆ¬í‘œì‹œ ë ˆë²¨ì— ë”°ë¼ ì¶”ì²œìˆ˜ê°€ ì˜¬ë¼ê°‰ë‹ˆë‹¤.<br>
                                                    ğŸ’€ í•´ê³¨ : +1 íš¨ê³¼<br>
                                                    ğŸ¥‰ ë™ë©”ë‹¬ : +2 íš¨ê³¼<br>
                                                    ğŸ¥ˆ ì€ë©”ë‹¬ : +4 íš¨ê³¼<br>
                                                    ğŸ¥‡ ê¸ˆë©”ë‹¬ : +8 íš¨ê³¼<br>
                                                    ğŸ’ ë‹¤ì´ì•„ : +16 íš¨ê³¼<br><br>
                                                    <strong>í˜„ì¬: {{ comment.author.level_info.level_name }} (+{{ comment.author.level_info.voting_power }})</strong><br><br>
                                                    <span style="color: #ff6b6b; font-size: 11px;">âš ï¸ ë¶€ì •í•œ ë°©ë²•ìœ¼ë¡œ í¬ì¸íŠ¸ë¥¼ ì–´ë·°ì§•í•˜ëŠ” ê²½ìš°,<br>í•´ê³¨ë¡œ ê°•ë“±ë  ìˆ˜ ìˆìŒ</span>
                                                </div>
                                            </span>
                                            {% endif %}
                                            {{ comment.author.nick }}
                                            {% if comment.author.level_info %}
                                            <span class="user-points-small">({{ comment.author.level_info.point }}P)</span>
                                            {% endif %}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </span>
                                    <div class="comment-actions">
                                        <button class="comment-vote-btn" onclick="voteComment({{ comment.id }}, 'plus')">
                                            ğŸ‘ {{ comment.vote_plus }}
                                        </button>
                                        <button class="comment-vote-btn" onclick="voteComment({{ comment.id }}, 'minus')">
                                            ğŸ‘ {{ comment.vote_minus }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-comments">
                            í˜„ì¬ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    <script>
        const discussionId = {{ discussion.id }};

        async function vote(type) {
            if (!confirm(`ì´ í† ë¡ ì— ${type === 'chan' ? 'ì°¬ì„±' : 'ë°˜ëŒ€'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œ ë¶ˆê°€)`)) {
                return;
            }

            try {
                const response = await fetch(`/api/vote/${discussionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ vote_type: type })
                });

                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/login';
                    } else {
                        alert(result.message);
                    }
                }
            } catch (error) {
                alert('íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        async function saveComment() {
            const content = document.getElementById('commentContent').value.trim();
            const chanban = document.querySelector('input[name="opinion"]:checked').value;

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        content_id: discussionId,
                        chanban: parseInt(chanban)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/login';
                    } else {
                        alert(result.message);
                    }
                }
            } catch (error) {
                alert('ëŒ“ê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        async function voteComment(commentId, type) {
            try {
                const response = await fetch(`/api/vote-comment/${commentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ vote_type: type })
                });

                const result = await response.json();

                if (result.success) {
                    location.reload();
                } else {
                    alert(result.message || 'íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        async function deleteDiscussion() {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-discussion/${discussionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.href = '/';
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }
    </script>
</body>
</html>