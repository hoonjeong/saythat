<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - SayThat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1 class="logo" onclick="location.href='/'">SayThat</h1>
                <h2>로그인</h2>
            </div>

            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="email">이메일</label>
                    <input type="email" id="email" name="email" required placeholder="이메일을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" name="password" required placeholder="비밀번호를 입력하세요">
                </div>

                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="saveEmail" name="saveEmail">
                        <span>이메일 저장</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="autoLogin" name="autoLogin">
                        <span>자동 로그인</span>
                    </label>
                </div>

                <button type="submit" class="auth-btn">로그인</button>
            </form>

            <div class="auth-footer">
                <div class="auth-links">
                    <a href="/register">회원가입</a>
                    <span>•</span>
                    <a href="#" onclick="showForgotPassword()">비밀번호 찾기</a>
                </div>
                <a href="/" class="back-home">홈으로 돌아가기</a>
            </div>
        </div>
    </div>

    <!-- 비밀번호 찾기 팝업 -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeForgotPassword()">&times;</span>
            <h3>비밀번호 찾기</h3>
            <p>가입 시 사용한 이메일을 입력하시면 임시 비밀번호를 발송해드립니다.</p>
            <input type="email" id="resetEmail" placeholder="이메일을 입력하세요">
            <button onclick="resetPassword()">임시 비밀번호 발송</button>
        </div>
    </div>

    <script>
        // 페이지 로드 시 저장된 이메일 불러오기 및 자동 로그인 체크
        window.addEventListener('DOMContentLoaded', function() {
            const savedEmail = localStorage.getItem('savedEmail');
            const autoLoginData = localStorage.getItem('autoLoginData');
            
            if (savedEmail) {
                document.getElementById('email').value = savedEmail;
                document.getElementById('saveEmail').checked = true;
            }
            
            // 자동 로그인 데이터가 있으면 자동 로그인 시도
            if (autoLoginData) {
                const data = JSON.parse(autoLoginData);
                // 토큰 유효기간 체크 (30일)
                if (data.expiry && new Date(data.expiry) > new Date()) {
                    autoLogin(data.email, data.token);
                } else {
                    // 만료된 자동 로그인 데이터 삭제
                    localStorage.removeItem('autoLoginData');
                }
            }
        });
        
        async function autoLogin(email, token) {
            try {
                const response = await fetch('/api/auto-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        token: token
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = '/';
                } else {
                    // 자동 로그인 실패 시 데이터 삭제
                    localStorage.removeItem('autoLoginData');
                }
            } catch (error) {
                console.error('자동 로그인 실패:', error);
                localStorage.removeItem('autoLoginData');
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const saveEmail = document.getElementById('saveEmail').checked;
            const autoLogin = document.getElementById('autoLogin').checked;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        auto_login: autoLogin
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 이메일 저장 처리
                    if (saveEmail) {
                        localStorage.setItem('savedEmail', email);
                    } else {
                        localStorage.removeItem('savedEmail');
                    }
                    
                    // 자동 로그인 처리
                    if (autoLogin && result.auto_login_token) {
                        const expiry = new Date();
                        expiry.setDate(expiry.getDate() + 30); // 30일 후 만료
                        localStorage.setItem('autoLoginData', JSON.stringify({
                            email: email,
                            token: result.auto_login_token,
                            expiry: expiry.toISOString()
                        }));
                    } else {
                        localStorage.removeItem('autoLoginData');
                    }
                    
                    window.location.href = '/';
                } else {
                    alert(result.message || '로그인에 실패했습니다.');
                }
            } catch (error) {
                alert('로그인 중 오류가 발생했습니다.');
                console.error(error);
            }
        });

        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'block';
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('resetEmail').value = '';
        }

        async function resetPassword() {
            const email = document.getElementById('resetEmail').value;
            
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();

                if (result.success) {
                    alert('임시 비밀번호가 이메일로 발송되었습니다.');
                    closeForgotPassword();
                } else {
                    alert(result.message || '비밀번호 재설정에 실패했습니다.');
                }
            } catch (error) {
                alert('오류가 발생했습니다.');
                console.error(error);
            }
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('forgotPasswordModal');
            if (event.target == modal) {
                closeForgotPassword();
            }
        }
    </script>
</body>
</html>